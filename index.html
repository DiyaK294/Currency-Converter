<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Currency Converter â€” Pro (Favorites + Chart)</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --panel-2:#0b1223;     /* darker */
      --text:#e5e7eb;        /* gray-200 */
      --muted:#9ca3af;       /* gray-400 */
      --accent:#22d3ee;      /* cyan-400 */
      --accent-2:#38bdf8;    /* sky-400 */
      --ring:#7dd3fc;        /* sky-300 */
      --danger:#fca5a5;      /* red-300 */
      --ok:#86efac;          /* green-300 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background:
        radial-gradient(1200px 600px at 15% -10%, #1e3a8a22, transparent),
        radial-gradient(1000px 500px at 100% 0%, #0ea5e933, transparent),
        var(--bg);
      color:var(--text); display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .card{
      width:min(960px, 96vw);
      background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid #1f2937; border-radius:20px; padding:22px;
      box-shadow: 0 30px 80px #0006, inset 0 1px 0 #ffffff0a;
    }
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:12px;
    }
    .title{font-weight:800; font-size:clamp(18px, 2vw, 22px)}
    .status{font-size:13px; color:var(--muted)}
    .grid{
      display:grid; grid-template-columns: 1fr auto 1fr; gap:14px; align-items:end;
    }
    @media (max-width:720px){ .grid{ grid-template-columns: 1fr; } .only-wide{ display:none } }
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input[type="number"], input[readonly], select{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid #1f2937;
      background:#0b1223; color:var(--text); outline:none;
      box-shadow: inset 0 1px 0 #ffffff0a;
    }
    input[type="number"]:focus, select:focus{ border-color:var(--ring); box-shadow: 0 0 0 3px #38bdf81f }

    /* Swap / icons */
    .swap, .icon-btn{
      display:flex; align-items:center; justify-content:center;
      width:48px; height:48px; border-radius:12px; border:1px solid #1f2937;
      background:#0b1223; user-select:none; transition: transform .06s ease-in-out, box-shadow .2s;
      position:relative;
    }
    .swap{ cursor:pointer; }
    .swap:hover, .icon-btn:hover{ box-shadow: 0 0 0 3px #38bdf80f }
    .swap:active, .icon-btn:active{ transform: scale(0.96) }
    .swap svg, .icon-btn svg{ width:22px; height:22px; fill:var(--accent) }
    .icon-btn{ cursor:pointer }
    .icon-btn.star.active svg{ fill:gold }

    /* Tooltip for swap */
    .swap .tip{
      position:absolute; bottom:110%; left:50%; transform:translateX(-50%);
      background:#111827; color:#e5e7eb; padding:6px 8px; border-radius:6px;
      font-size:12px; white-space:nowrap; box-shadow:0 2px 10px #0009;
      opacity:0; pointer-events:none; transition:opacity .15s, transform .15s;
      transform-origin:bottom center; translate:0 4px;
    }
    .swap:hover .tip, .swap:focus-visible .tip{ opacity:1; translate:0 0 }

    .actions{
      display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px;
    }
    .btn{
      width:100%; padding:12px 14px; border:none; border-radius:12px; cursor:pointer;
      background:linear-gradient(135deg, var(--accent), var(--accent-2));
      color:#06111e; font-weight:700; letter-spacing:.2px;
      box-shadow: 0 10px 30px #38bdf855, inset 0 1px 0 #fff3;
    }
    .btn.ghost{
      background:#0b1223; color:var(--text); border:1px solid #1f2937; box-shadow:none;
    }
    .btn.danger{
      background:linear-gradient(135deg, #fda4af, #fecaca); color:#3f0b0b; box-shadow:0 10px 30px #fda4af55, inset 0 1px 0 #fff3;
    }

    .rate-line{ margin-top:10px; font-size:14px; color:#cbd5e1; }
    .footer{ display:flex; justify-content:space-between; align-items:center; margin-top:10px }
    .tiny{ font-size:12px; color:var(--muted) }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace }

    /* Favorites bar */
    .favbar{
      display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:end; margin-top:10px;
    }
    .fav-inline{ display:flex; gap:8px; align-items:center }
    .tinybtn{
      border:1px solid #1f2937; background:#0b1223; color:var(--text);
      border-radius:10px; padding:8px 12px; cursor:pointer;
    }
    .tinybtn:hover{ box-shadow:0 0 0 3px #38bdf80f }

    /* Chart */
    .chart-wrap{
      margin-top:18px; border:1px solid #1f2937; border-radius:16px; padding:12px;
      background:#0b1223; box-shadow: inset 0 1px 0 #ffffff0a;
    }
    .chart-header{
      display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;
    }
    .chips{ display:flex; gap:8px; flex-wrap:wrap }
    .chip{
      font-size:12px; padding:8px 10px; border-radius:999px; cursor:pointer; border:1px solid #1f2937; background:#0b1223; color:#e5e7eb;
    }
    .chip.active{ border-color:var(--ring); box-shadow:0 0 0 3px #38bdf81a }
    canvas{ width:100%; height:260px; display:block }
    .chart-meta{ display:flex; justify-content:space-between; gap:8px; font-size:12px; color:#cbd5e1; padding-top:6px }
    .chg.up{ color:var(--ok) }
    .chg.down{ color:#fca5a5 }

    .error{ color:var(--danger); font-size:13px; margin-top:8px; min-height:18px }
    .kbd{ font-family:ui-monospace,Menlo,monospace; font-size:12px; padding:2px 6px; border:1px solid #1f2937; border-radius:6px; background:#0b1223; color:#cbd5e1 }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <div class="title">ðŸ’± Currency Converter</div>
      <div class="status" id="status">Loadingâ€¦</div>
    </div>

    <div class="grid" id="converter">
      <div>
        <label for="amount">Amount</label>
        <input id="amount" type="number" min="0" step="0.01" placeholder="Enter amount" value="100" />
      </div>

      <!-- middle controls: swap + favorite -->
      <div class="only-wide" style="display:grid; gap:8px; justify-items:center">
        <button class="swap" id="swapBtn" title="Reverse Currency" aria-label="Reverse Currency">
          <svg viewBox="0 0 24 24"><path d="M7 7h11l-3.5-3.5 1.4-1.4L22 8l-6.1 5.9-1.4-1.4L18 9H7V7zm10 10H6l3.5 3.5-1.4 1.4L2 16l6.1-5.9 1.4 1.4L6 15h11v2z"/></svg>
          <span class="tip">Reverse Currency</span>
        </button>
        <button class="icon-btn star" id="favBtn" title="Save/Remove favorite (F)" aria-label="Toggle Favorite">
          <svg viewBox="0 0 24 24"><path d="M12 17.3l-6.2 3.7 1.6-6.9L2 9.6l7-0.6L12 2l3 7 7 .6-5.3 4.5 1.6 6.9z"/></svg>
        </button>
      </div>

      <div>
        <label for="result">Converted</label>
        <input id="result" type="text" placeholder="0.00" readonly />
      </div>

      <div>
        <label for="from">From</label>
        <select id="from"></select>
      </div>

      <div class="only-wide"></div>

      <div>
        <label for="to">To</label>
        <select id="to"></select>
      </div>
    </div>

    <div class="rate-line" id="rateLine">â€”</div>

    <!-- Favorites bar -->
    <div class="favbar">
      <div>
        <label for="favorites">Favorites</label>
        <div class="fav-inline">
          <select id="favorites"></select>
          <button class="tinybtn" id="applyFavBtn" title="Apply favorite">Apply</button>
          <button class="tinybtn" id="removeFavBtn" title="Remove selected">ðŸ—‘</button>
        </div>
      </div>
      <div class="tiny" style="text-align:right">
        Tips: <span class="kbd">Enter</span> Convert Â· <span class="kbd">S</span> Swap Â· <span class="kbd">F</span> Favorite
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="convertBtn">Convert</button>
      <button class="btn" id="copyBtn" title="Copy result">Copy Result</button>
    </div>

    <!-- Chart -->
    <div class="chart-wrap">
      <div class="chart-header">
        <div class="tiny">Trend (close rate)</div>
        <div class="chips">
          <button class="chip" data-days="7">7D</button>
          <button class="chip active" data-days="30">30D</button>
          <button class="chip" data-days="90">90D</button>
        </div>
      </div>
      <canvas id="chart" width="800" height="260" aria-label="Historical exchange rate chart"></canvas>
      <div class="chart-meta">
        <div id="chartRange">â€”</div>
        <div id="chartChange" class="chg">â€”</div>
      </div>
    </div>

    <div class="footer">
      <div class="tiny" id="updatedAt">Updated: â€”</div>
      <div class="tiny">Source: exchangerate.host</div>
    </div>

    <div class="error mono" id="error"></div>
  </div>

  <script>
    // -------- Config & Globals --------
    const FALLBACK_RATES = {
      // base: USD (for fallback math)
      "EUR": 0.91, "GBP": 0.77, "INR": 83.0, "JPY": 156.0, "AUD": 1.49, "CAD": 1.36,
      "CNY": 7.25, "CHF": 0.88, "SGD": 1.35, "ZAR": 18.0, "AED": 3.67, "USD": 1
    };
    // Popular codes pinned at top (codes-only labels)
    const POPULAR = ["USD","EUR","GBP","INR","JPY","AUD","CAD","CNY","CHF","SGD","ZAR","AED"];

    const els = {
      amount: document.getElementById('amount'),
      result: document.getElementById('result'),
      from: document.getElementById('from'),
      to: document.getElementById('to'),
      status: document.getElementById('status'),
      error: document.getElementById('error'),
      rateLine: document.getElementById('rateLine'),
      updatedAt: document.getElementById('updatedAt'),
      swapBtn: document.getElementById('swapBtn'),
      convertBtn: document.getElementById('convertBtn'),
      copyBtn: document.getElementById('copyBtn'),
      favBtn: document.getElementById('favBtn'),
      favSelect: document.getElementById('favorites'),
      favApply: document.getElementById('applyFavBtn'),
      favRemove: document.getElementById('removeFavBtn'),
      chart: document.getElementById('chart'),
      chartRange: document.getElementById('chartRange'),
      chartChange: document.getElementById('chartChange'),
      chips: Array.from(document.querySelectorAll('.chip')),
    };

    const cacheKeyRates = (base) => `fx:${base.toUpperCase()}`;
    const cacheKeyTs = (base, quote, days) => `fx:ts:${base.toUpperCase()}->${quote.toUpperCase()}:${days}`;
    const cacheFavs = `fx:favorites`;
    const cacheSymbols = `fx:symbols`;
    const CACHE_TTL_MS = 12 * 60 * 60 * 1000; // 12 hours
    const TS_TTL_MS = 12 * 60 * 60 * 1000; // 12 hours
    const SYM_TTL_MS = 7 * 24 * 60 * 60 * 1000; // 7 days

    let lastRates = null; // last getRates() result
    let currentDays = 30;

    // ---- Formatting helpers ----
    const fmtNum = (n, max=6) => {
      const s = (+n).toFixed(max);
      return s.replace(/\.?0+$/, '');
    };

    // -------- Init --------
    init();

    async function init(){
      const allCodes = await fetchSymbols(); // {USD:"US Dollar", ...}
      buildSelectCodesOnly(els.from, allCodes, "USD");
      buildSelectCodesOnly(els.to, allCodes, "INR");
      loadFavorites();
      attachEvents();
      els.status.textContent = "Ready";
      await convert();    // first conversion
      await refreshChart(); // first chart
      window.addEventListener('resize', debounce(refreshChart, 150));
    }

    // -------- Symbols (currency list) --------
    async function fetchSymbols(){
      const now = Date.now();
      try{
        const cached = JSON.parse(localStorage.getItem(cacheSymbols) || "null");
        if (cached && now - cached._savedAt < SYM_TTL_MS) return cached.symbols;
      }catch{}

      try{
        const res = await fetch('https://api.exchangerate.host/symbols');
        if(!res.ok) throw new Error('sym net');
        const data = await res.json();
        const symbols = {};
        Object.values(data.symbols || {}).forEach(s => {
          symbols[s.code] = s.description || s.code;
        });
        localStorage.setItem(cacheSymbols, JSON.stringify({_savedAt: now, symbols}));
        return symbols;
      }catch(e){
        // Minimal fallback names
        return {
          "USD":"US Dollar","EUR":"Euro","GBP":"British Pound","INR":"Indian Rupee","JPY":"Japanese Yen",
          "AUD":"Australian Dollar","CAD":"Canadian Dollar","CNY":"Chinese Yuan","CHF":"Swiss Franc",
          "SGD":"Singapore Dollar","ZAR":"South African Rand","AED":"UAE Dirham"
        };
      }
    }

    // ---- Build dropdowns with codes-only, grouped ----
    function buildSelectCodesOnly(select, codesMap, preferred){
      select.innerHTML = "";

      const makeOpt = (code) => {
        const o = document.createElement('option');
        o.value = code; o.textContent = code; // CODE ONLY label
        return o;
      };

      // Popular group
      const popularGroup = document.createElement('optgroup');
      popularGroup.label = "Popular";
      for(const code of POPULAR){
        if (codesMap[code]) popularGroup.appendChild(makeOpt(code));
      }
      select.appendChild(popularGroup);

      // All codes group (excluding popular)
      const allGroup = document.createElement('optgroup');
      allGroup.label = "All Currencies";
      Object.keys(codesMap).sort().forEach(code => {
        if(!POPULAR.includes(code)){
          allGroup.appendChild(makeOpt(code));
        }
      });
      select.appendChild(allGroup);

      if(preferred && codesMap[preferred]) select.value = preferred;
    }

    // -------- Events --------
    function attachEvents(){
      // Core
      els.swapBtn?.addEventListener('click', () => { swap(); convert(); refreshChart(); });
      els.convertBtn.addEventListener('click', () => convert());
      els.amount.addEventListener('input', debounce(() => convert(), 200));
      els.from.addEventListener('change', () => { convert(); refreshChart(); updateFavStar(); });
      els.to.addEventListener('change', () => { convert(); refreshChart(); updateFavStar(); });

      // Clipboard
      els.copyBtn.addEventListener('click', async () => {
        try{
          await navigator.clipboard.writeText(els.result.value || "");
          transientStatus("Copied âœ“");
        }catch(e){ transientStatus("Copy failed"); }
      });

      // Favorites
      els.favBtn.addEventListener('click', toggleFavorite);
      els.favApply.addEventListener('click', () => {
        const sel = els.favSelect.value;
        if(!sel) return;
        const [b, q] = sel.split('->');
        els.from.value = b; els.to.value = q;
        updateFavStar();
        convert();
        refreshChart();
      });
      els.favRemove.addEventListener('click', () => {
        const sel = els.favSelect.value;
        if(!sel) return;
        const favs = getFavorites().filter(p => p !== sel);
        localStorage.setItem(cacheFavs, JSON.stringify(favs));
        loadFavorites(sel);
        updateFavStar();
      });

      // Chart range chips
      els.chips.forEach(chip => chip.addEventListener('click', () => {
        els.chips.forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        currentDays = +chip.dataset.days;
        refreshChart();
      }));

      // Keyboard shortcuts
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); convert(); }
        if (e.key.toLowerCase() === 's') { e.preventDefault(); swap(); convert(); refreshChart(); }
        if (e.key.toLowerCase() === 'f') { e.preventDefault(); toggleFavorite(); }
      });

      // Update star state initially
      updateFavStar();
    }

    function swap(){
      const a = els.from.value, b = els.to.value;
      els.from.value = b; els.to.value = a;
      updateFavStar();
    }

    function transientStatus(text){
      const old = els.status.textContent;
      els.status.textContent = text;
      setTimeout(()=> els.status.textContent = old, 900);
    }

    // -------- Conversion --------
    async function convert(){
      clearError();
      const amount = parseFloat(els.amount.value || "0");
      const base = els.from.value;
      const quote = els.to.value;

      if (!isFinite(amount)) { showError("Enter a valid number."); return; }
      if (amount < 0) { showError("Amount cannot be negative."); return; }

      try{
        lastRates = await getRates(base);
        const rate = rateFor(lastRates, base, quote);
        const converted = amount * rate;

        els.result.value = fmtNum(converted);
        els.rateLine.textContent =
          `1 ${base} = ${fmtNum(rate)} ${quote}   |   1 ${quote} = ${fmtNum(1/rate)} ${base}`;

        const updated = new Date(lastRates.timestamp || lastRates.date || Date.now());
        els.updatedAt.textContent = `Updated: ${updated.toLocaleString()}`;
      }catch(err){
        showError(err.message || "Conversion failed.");
      }
    }

    async function getRates(base){
      base = base.toUpperCase();
      const now = Date.now();
      // Try cache
      const cached = localStorage.getItem(cacheKeyRates(base));
      if (cached){
        try{
          const obj = JSON.parse(cached);
          if (now - obj._savedAt < CACHE_TTL_MS){
            return obj;
          }
        }catch{}
      }

      // Fetch fresh
      try{
        const res = await fetch(`https://api.exchangerate.host/latest?base=${encodeURIComponent(base)}`);
        if(!res.ok) throw new Error("Network error");
        const data = await res.json();
        if(!data || !data.rates) throw new Error("Bad response");

        const payload = {
          base: base,
          rates: data.rates,
          date: data.date,
          timestamp: Date.now(),
          _savedAt: now
        };
        localStorage.setItem(cacheKeyRates(base), JSON.stringify(payload));
        return payload;
      }catch(e){
        const fb = synthesizeFromFallback(base);
        if (fb) return fb;
        throw new Error("Couldnâ€™t fetch rates and no fallback available.");
      }
    }

    function synthesizeFromFallback(base){
      base = base.toUpperCase();
      if (!(base in FALLBACK_RATES)) return null;

      // Build cross rates using USD as pivot: rate(base->X) = USD->X / USD->base
      const pivot = FALLBACK_RATES;
      const denom = pivot[base];
      const rates = {};
      Object.keys(pivot).forEach(code => {
        rates[code] = pivot[code] / denom;
      });
      return { base, rates, date: "fallback", timestamp: Date.now(), _savedAt: Date.now() };
    }

    function rateFor(dataset, base, quote){
      base = base.toUpperCase(); quote = quote.toUpperCase();
      if (base === quote) return 1;
      const r = dataset?.rates?.[quote];
      if (!r) throw new Error(`No rate for ${base} â†’ ${quote}`);
      return r;
    }

    // -------- Favorites --------
    function getFavorites(){
      try{
        return JSON.parse(localStorage.getItem(cacheFavs) || "[]");
      }catch{ return []; }
    }

    function saveFavorites(arr){
      localStorage.setItem(cacheFavs, JSON.stringify(arr));
    }

    function pairKey(b, q){ return `${b.toUpperCase()}->${q.toUpperCase()}`; }

    function isFavorite(b, q){
      return getFavorites().includes(pairKey(b,q));
    }

    function updateFavStar(){
      const fav = isFavorite(els.from.value, els.to.value);
      els.favBtn.classList.toggle('active', fav);
      els.favBtn.title = fav ? "Remove from favorites (F)" : "Save as favorite (F)";
      loadFavorites(); // keep dropdown fresh
    }

    function toggleFavorite(){
      const b = els.from.value, q = els.to.value;
      const key = pairKey(b,q);
      const favs = getFavorites();
      const idx = favs.indexOf(key);
      if (idx >= 0){
        favs.splice(idx,1);
        saveFavorites(favs);
        transientStatus("Removed â˜…");
      } else {
        favs.push(key);
        saveFavorites(favs);
        transientStatus("Saved â˜…");
      }
      loadFavorites();
      updateFavStar();
    }

    function loadFavorites(removed){
      const favs = getFavorites();
      els.favSelect.innerHTML = "";
      if (favs.length === 0){
        const opt = document.createElement('option');
        opt.value = ""; opt.textContent = "â€” none â€”";
        els.favSelect.appendChild(opt);
        els.favSelect.disabled = true;
        els.favApply.disabled = true;
        els.favRemove.disabled = true;
        return;
      }
      els.favSelect.disabled = false;
      els.favApply.disabled = false;
      els.favRemove.disabled = false;

      favs.forEach(k => {
        const opt = document.createElement('option');
        opt.value = k; opt.textContent = k.replace('->',' â†’ ');
        els.favSelect.appendChild(opt);
      });
      // if a removed item was selected, move selection to first
      if (removed && els.favSelect.value === removed) els.favSelect.selectedIndex = 0;
    }

    // -------- Chart (Canvas, no libs) --------
    async function refreshChart(){
      const base = els.from.value.toUpperCase();
      const quote = els.to.value.toUpperCase();
      const days = currentDays;
      let points;

      try{
        points = await getTimeseries(base, quote, days);
      }catch(e){
        // fallback: flat line from current spot rate
        try{
          const r = rateFor(lastRates || await getRates(base), base, quote);
          const today = new Date();
          points = Array.from({length: days}, (_,i)=>{
            const d = new Date(today); d.setDate(d.getDate() - (days-1-i));
            return { date: d.toISOString().slice(0,10), value: r };
          });
        }catch{ points = []; }
      }

      drawChart(points, base, quote);
    }

    async function getTimeseries(base, quote, days){
      const now = Date.now();
      const key = cacheKeyTs(base, quote, days);
      const cached = localStorage.getItem(key);
      if (cached){
        try{
          const obj = JSON.parse(cached);
          if (now - obj._savedAt < TS_TTL_MS) return obj.points;
        }catch{}
      }
      const end = new Date();
      const start = new Date(); start.setDate(start.getDate() - (days-1));
      const endStr = end.toISOString().slice(0,10);
      const startStr = start.toISOString().slice(0,10);

      const url = `https://api.exchangerate.host/timeseries?start_date=${startStr}&end_date=${endStr}&base=${encodeURIComponent(base)}&symbols=${encodeURIComponent(quote)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error("Timeseries network error");
      const data = await res.json();
      if(!data || !data.rates) throw new Error("Timeseries bad response");

      const dates = Object.keys(data.rates).sort();
      const pts = dates.map(d => ({ date: d, value: data.rates[d][quote] })).filter(p => typeof p.value === 'number');

      localStorage.setItem(key, JSON.stringify({ _savedAt: now, points: pts }));
      return pts;
    }

    function drawChart(points, base, quote){
      const canvas = els.chart;
      const ctx = canvas.getContext('2d');

      // DPI scaling
      const dpr = window.devicePixelRatio || 1;
      const cssW = canvas.clientWidth;
      const cssH = canvas.clientHeight;
      if (canvas.width !== Math.round(cssW*dpr)) {
        canvas.width = Math.round(cssW*dpr);
        canvas.height = Math.round(cssH*dpr);
      }
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels

      // Clear
      ctx.clearRect(0,0,cssW,cssH);

      // No data?
      if (!points || points.length === 0){
        ctx.fillStyle = '#94a3b8';
        ctx.font = '14px system-ui, -apple-system, Segoe UI, Roboto';
        ctx.fillText('No data to display', 10, 20);
        els.chartRange.textContent = 'â€”';
        els.chartChange.textContent = 'â€”';
        els.chartChange.className = 'chg';
        return;
      }

      const pad = { l: 40, r: 12, t: 10, b: 24 };
      const W = cssW - pad.l - pad.r;
      const H = cssH - pad.t - pad.b;

      // Compute bounds
      let minY = Math.min(...points.map(p => p.value));
      let maxY = Math.max(...points.map(p => p.value));
      if (minY === maxY){ const eps = minY === 0 ? 1 : minY*0.01; minY -= eps; maxY += eps; }

      // Axes
      ctx.strokeStyle = '#1f2937';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad.l, cssH - pad.b + .5);
      ctx.lineTo(cssW - pad.r, cssH - pad.b + .5);
      ctx.moveTo(pad.l + .5, pad.t);
      ctx.lineTo(pad.l + .5, cssH - pad.b);
      ctx.stroke();

      // Y ticks (min/mid/max)
      ctx.fillStyle = '#94a3b8';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto';
      const yTick = (v)=> pad.t + (1 - (v - minY)/(maxY - minY))*H;
      [minY, (minY+maxY)/2, maxY].forEach((v) => {
        const y = yTick(v);
        ctx.strokeStyle = '#1f2937';
        ctx.beginPath(); ctx.moveTo(pad.l, y+.5); ctx.lineTo(cssW - pad.r, y+.5); ctx.stroke();
        ctx.fillText(fmtNum(v,4), 4, y-2);
      });

      // X labels (start/end)
      const startLabel = points[0].date;
      const endLabel = points[points.length-1].date;
      ctx.fillText(startLabel, pad.l, cssH - 6);
      const endW = ctx.measureText(endLabel).width;
      ctx.fillText(endLabel, cssW - pad.r - endW, cssH - 6);

      // Helpers
      const xAt = (i)=> pad.l + (i/(points.length-1))*W;
      const yAt = (v)=> pad.t + (1 - (v - minY)/(maxY - minY))*H;

      // Line gradient
      ctx.lineWidth = 2;
      const grad = ctx.createLinearGradient(0,pad.t,0,cssH - pad.b);
      grad.addColorStop(0, '#22d3ee');
      grad.addColorStop(1, '#38bdf8');
      ctx.strokeStyle = grad;

      // Path for line
      ctx.beginPath();
      points.forEach((p,i) => {
        const x = xAt(i), y = yAt(p.value);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // Fill under line
      const fillGrad = ctx.createLinearGradient(0,pad.t,0,cssH - pad.b);
      fillGrad.addColorStop(0, 'rgba(56,189,248,0.25)');
      fillGrad.addColorStop(1, 'rgba(56,189,248,0.03)');
      ctx.fillStyle = fillGrad;
      ctx.beginPath();
      points.forEach((p,i) => {
        const x = xAt(i), y = yAt(p.value);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.lineTo(pad.l + W, cssH - pad.b);
      ctx.lineTo(pad.l, cssH - pad.b);
      ctx.closePath();
      ctx.fill();

      // Last point dot
      const last = points[points.length-1];
      const lx = xAt(points.length-1), ly = yAt(last.value);
      ctx.fillStyle = '#22d3ee';
      ctx.beginPath(); ctx.arc(lx, ly, 3, 0, Math.PI*2); ctx.fill();

      // Meta text
      els.chartRange.textContent = `${startLabel} â†’ ${endLabel} â€¢ ${base}â†’${quote}`;
      const first = points[0].value, lastv = last.value;
      const diffPct = ((lastv - first) / first) * 100;
      const sign = diffPct >= 0 ? '+' : '';
      els.chartChange.textContent = `${sign}${fmtNum(diffPct,2)}% ${diffPct>=0?'â†‘':'â†“'}`;
      els.chartChange.className = 'chg ' + (diffPct>=0 ? 'up' : 'down');
    }

    // -------- UI helpers --------
    function showError(msg){ els.error.textContent = msg; }
    function clearError(){ els.error.textContent = ""; }
    function debounce(fn, ms){
      let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), ms); };
    }
  </script>
</body>
</html>
